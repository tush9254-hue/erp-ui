<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MutukuERP — Odoo Lite (All-in-One)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Supabase ESM loader -->
  <script type="module">
    import * as supabaseLib from 'https://esm.sh/@supabase/supabase-js@2';
    window.SupabaseCreateClient = supabaseLib.createClient;
  </script>

  <!-- PDF libraries for client-side export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --muted:#6b7785; --accent:#0b63ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#111}
    .topbar{height:60px;background:#fff;display:flex;align-items:center;padding:0 20px;box-shadow:0 1px 0 rgba(20,20,50,.04)}
    .brand{font-weight:700;margin-right:18px}
    .small{font-size:13px;color:var(--muted)}
    .container{display:flex;height:calc(100vh - 60px)}
    .sidebar{width:240px;background:#fff;border-right:1px solid #eef2f7;padding:18px;overflow:auto}
    .menu{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .menu button{background:transparent;border:none;padding:10px 12px;border-radius:8px;text-align:left;cursor:pointer;font-size:15px;color:#222}
    .menu button.active{background:#eef5ff;color:var(--accent);font-weight:600}
    .content{flex:1;padding:18px;overflow:auto}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(20,20,50,.04);margin-bottom:14px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:10px;align-items:center}
    input,select,textarea,button{font-size:14px}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e2e6ee}
    button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
    .btn{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:1px solid #d6e2ff;color:var(--accent)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f0f2f5;text-align:left}
    .mono{font-family:monospace;background:#f2f6fb;padding:3px 6px;border-radius:6px}
    pre#log{height:240px;overflow:auto;background:#fbfdff;padding:8px;border-radius:8px}
    .muted{color:var(--muted)}
    label.small{font-size:12px;color:var(--muted)}
    @media(max-width:900px){ .sidebar{display:none} .grid-3{grid-template-columns:1fr} }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">MutukuERP</div>
    <div class="small muted">Odoo Lite — Full ERP</div>
    <div style="flex:1"></div>
    <div id="auth-info" class="small muted">Not signed in</div>
  </div>

  <div class="container">
    <div class="sidebar">
      <div class="card">
        <div class="small muted">Supabase Config</div>
        <input id="supabase-url" placeholder="SUPABASE_URL" style="width:100%;margin-top:8px" />
        <input id="supabase-key" placeholder="SUPABASE_ANON_KEY" style="width:100%;margin-top:8px" />
        <button id="btn-init" class="btn" style="width:100%;margin-top:10px">Initialize Client</button>
      </div>

      <div class="menu" id="menu">
        <button data-view="dashboard" class="active">Dashboard</button>
        <button data-view="sales">Sales</button>
        <button data-view="payments">Payments</button>
        <button data-view="purchases">Purchases</button>
        <button data-view="products">Products</button>
        <button data-view="accounting">Accounting</button>
        <button data-view="reports">Reports</button>
        <button data-view="reconcile">Bank Reconciliation</button>
        <button data-view="settings">Settings</button>
      </div>

      <div style="height:12px"></div>
      <div class="card">
        <div class="small muted">Log</div>
        <pre id="log"></pre>
      </div>
    </div>

    <div class="content" id="content">

      <!-- Dashboard -->
      <div id="view-dashboard" class="view card">
        <h3>Dashboard</h3>
        <div class="grid-3" id="dashboard-cards">
          <div class="card"><h4>Sales (This month)</h4><div id="dash-sales" class="mono">—</div></div>
          <div class="card"><h4>Collections</h4><div id="dash-collections" class="mono">—</div></div>
          <div class="card"><h4>Receivables</h4><div id="dash-ar" class="mono">—</div></div>
        </div>
        <div class="card"><h4>Recent Activity</h4><div id="recent-activity" class="small muted">No activity yet.</div></div>
      </div>

      <!-- Sales -->
      <div id="view-sales" class="view hidden">
        <div class="row" style="justify-content:space-between">
          <h3>Sales</h3>
          <div class="row">
            <input id="email" placeholder="Email" />
            <input id="password" placeholder="Password" type="password" />
            <button id="btn-signup" class="btn ghost">Sign up</button>
            <button id="btn-signin" class="btn">Sign in</button>
            <button id="btn-signout" class="btn ghost hidden">Sign out</button>
          </div>
        </div>

        <div class="grid-3" style="margin-top:12px">
          <div class="card">
            <h4>Customers</h4>
            <div class="row">
              <input id="cust-id" placeholder="Customer ID (C0001)" />
              <input id="cust-name" placeholder="Customer name" />
              <button id="btn-add-customer" class="btn">Add</button>
            </div>
            <div id="customers-list" style="margin-top:10px"></div>
          </div>

          <div class="card">
            <h4>Create Invoice (atomic)</h4>
            <div class="row">
              <input id="inv-id" placeholder="Invoice ID" />
              <input id="inv-date" type="date" />
            </div>
            <div class="row" style="margin-top:8px">
              <select id="inv-customer"><option value="">Choose customer</option></select>
              <input id="inv-amount" type="number" placeholder="Amount" />
              <button id="btn-add-invoice" class="btn">Create (RPC)</button>
              <button id="btn-export-invoice" class="btn ghost">Export PDF</button>
            </div>
            <div style="margin-top:8px" class="small muted">On create, an atomic RPC posts invoice + JE</div>
          </div>

          <div class="card">
            <h4>Sales Invoices</h4>
            <div id="invoices-list"></div>
          </div>
        </div>
      </div>

      <!-- Payments -->
      <div id="view-payments" class="view hidden">
        <h3>Payments & Allocation</h3>
        <div class="grid-3" style="margin-top:12px">
          <div class="card">
            <h4>Record Payment (atomic)</h4>
            <div class="row">
              <input id="pay-id" placeholder="Payment ID" />
              <input id="pay-date" type="date" />
            </div>
            <div class="row" style="margin-top:8px">
              <select id="pay-customer"><option value="">Partner</option></select>
              <input id="pay-amount" type="number" placeholder="Amount" />
              <select id="pay-type"><option>Customer</option><option>Supplier</option></select>
              <button id="btn-add-payment" class="btn">Record (RPC)</button>
            </div>
            <div class="small muted" style="margin-top:8px">RPC posts JE DR Bank / CR AR (or reverse for supplier)</div>
          </div>

          <div class="card">
            <h4>Payments</h4>
            <div id="payments-list"></div>
          </div>

          <div class="card">
            <h4>Allocate Payment</h4>
            <div class="row">
              <select id="alloc-payment"><option value="">Select payment</option></select>
              <button id="btn-load-invoices" class="btn ghost">Load invoices</button>
            </div>
            <div id="alloc-invoices" style="margin-top:8px"></div>
            <div style="margin-top:8px"><button id="btn-apply-allocation" class="btn">Apply allocation (RPC)</button></div>
          </div>
        </div>
      </div>

      <!-- Purchases -->
      <div id="view-purchases" class="view hidden">
        <h3>Purchases (Supplier Bills)</h3>
        <div class="grid-3" style="margin-top:12px">
          <div class="card">
            <h4>Create Bill (atomic)</h4>
            <div class="row">
              <input id="bill-id" placeholder="Bill ID" />
              <input id="bill-date" type="date" />
            </div>
            <div class="row" style="margin-top:8px">
              <input id="supplier-id" placeholder="Supplier ID (S0001)" />
              <input id="bill-amount" type="number" placeholder="Amount" />
              <button id="btn-add-bill" class="btn">Create Bill (RPC)</button>
            </div>
          </div>

          <div class="card">
            <h4>Supplier Bills</h4>
            <div id="bills-list"></div>
          </div>

          <div class="card">
            <h4>Pay Supplier</h4>
            <div class="row">
              <input id="supplier-pay-id" placeholder="Payment ID" />
              <input id="supplier-pay-date" type="date" />
            </div>
            <div class="row" style="margin-top:8px">
              <select id="supplier-select"><option value="">Choose bill</option></select>
              <input id="supplier-pay-amount" type="number" placeholder="Amount" />
              <button id="btn-add-supp-payment" class="btn">Record (RPC)</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Products -->
      <div id="view-products" class="view hidden">
        <h3>Products & Stock</h3>
        <div class="card">
          <div class="row">
            <input id="prod-sku" placeholder="SKU" />
            <input id="prod-name" placeholder="Description" />
            <input id="prod-price" type="number" placeholder="Unit price" />
            <button id="btn-add-prod" class="btn">Add</button>
          </div>
          <div id="products-list" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Accounting -->
      <div id="view-accounting" class="view hidden">
        <h3>Accounting</h3>
        <div class="grid-3" style="margin-top:12px">
          <div class="card">
            <h4>Chart of Accounts</h4>
            <div id="coa-list"></div>
          </div>

          <div class="card">
            <h4>Journal Entries</h4>
            <div id="je-list"></div>
          </div>

          <div class="card">
            <h4>Trial Balance</h4>
            <button id="btn-load-trial" class="btn">Refresh</button>
            <div id="trial-list" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- Reports -->
      <div id="view-reports" class="view hidden card">
        <h3>Reports</h3>
        <div style="margin-bottom:10px"><button id="btn-ar-aging" class="btn ghost">Load AR Aging</button> <button id="btn-sales-report" class="btn ghost">Sales this month</button></div>
        <div id="reports-area" class="small muted"></div>
      </div>

      <!-- Bank Reconciliation -->
      <div id="view-reconcile" class="view hidden">
        <h3>Bank Reconciliation</h3>
        <div class="card">
          <div class="row">
            <input id="rec-bank-account" placeholder="Bank account name" />
            <input id="rec-date" type="date" />
            <input id="rec-statement-balance" placeholder="Statement balance" type="number" />
            <button id="btn-create-recon" class="btn">Create</button>
          </div>
          <div style="margin-top:8px" class="small muted">Upload statement lines later — For now you can create a reconciliation and match by JE.</div>
          <div id="recon-list" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Settings / Company Profile -->
      <div id="view-settings" class="view hidden card">
        <h3>Settings & Company Profile</h3>
        <div class="row">
          <input id="company-name" placeholder="Company name" style="width:60%" />
          <input id="company-pin" placeholder="PIN / Tax ID" style="width:35%" />
        </div>
        <div class="row" style="margin-top:8px">
          <input id="company-email" placeholder="Email" style="width:48%" />
          <input id="company-phone" placeholder="Phone" style="width:48%" />
        </div>
        <div class="row" style="margin-top:8px">
          <textarea id="company-address" placeholder="Address" style="width:100%;height:80px"></textarea>
        </div>
        <div style="margin-top:8px">
          <input id="company-logo" placeholder="Logo URL" style="width:100%" />
        </div>
        <div style="margin-top:8px">
          <button id="btn-save-company" class="btn">Save Company Profile</button>
          <button id="btn-load-company" class="btn ghost">Load</button>
        </div>
      </div>

    </div>
  </div>

<script>
/* =========================
   MutukuERP — All-in-One client
   Expects your Supabase schema & RPCs to exist:
   - Tables: customers, sales_invoices, payments, allocations, purchase_bills, products, chart_of_accounts, journal_entries, trial_balance, company_profile, activity_log, bank_reconciliations, bank_reconciliation_lines
   - RPCs: post_invoice, post_payment, post_bill, allocate_payment_atomic
   ========================= */

function log(msg){
  const box = document.getElementById('log');
  box.textContent = new Date().toLocaleTimeString() + ' — ' + msg + "\n" + box.textContent;
}
let client = null;

/* ----------------- menu ----------------- */
document.querySelectorAll('#menu button').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('#menu button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const v = b.dataset.view;
    document.querySelectorAll('.view').forEach(view=> view.classList.add('hidden'));
    document.getElementById('view-' + v).classList.remove('hidden');
  });
});

/* ----------------- Initialize supabase client ----------------- */
document.getElementById('btn-init').onclick = async () => {
  const url = document.getElementById('supabase-url').value.trim();
  const key = document.getElementById('supabase-key').value.trim();
  if(!url || !key) return alert('Enter SUPABASE_URL and SUPABASE_ANON_KEY');

  if(!window.SupabaseCreateClient) return alert('Supabase loader missing');
  client = window.SupabaseCreateClient(url, key);
  log('Supabase client created.');

  // test connectivity
  try{
    const { error } = await client.from('customers').select('*').limit(1);
    if(error){ log('Connection test error: ' + error.message); }
    else {
      log('Connected to Supabase successfully.');
      initAfterConnect();
    }
  }catch(e){ log('Init error: ' + e.message); }
};

/* ----------------- After client ready ----------------- */
function initAfterConnect(){
  wireAuth();
  // load UI data
  loadCustomers();
  loadInvoices();
  loadPayments();
  loadBills();
  loadProducts();
  loadCOA();
  loadJournalEntries();
  loadTrialBalance();
  refreshDashboard();
  loadCompanyProfile();
}

/* =========================
   RPC helpers (call server functions)
   ========================= */
async function rpc_postInvoice(invoice_id, invoice_date, customer_id, amount){
  if(!client) throw new Error('Init client first');
  const { data, error } = await client.rpc('post_invoice', { p_invoice_id: invoice_id, p_invoice_date: invoice_date, p_customer_id: customer_id, p_amount: amount });
  if(error) throw error;
  log('RPC post_invoice OK: ' + invoice_id);
  return data;
}

async function rpc_postPayment(payment_id, payment_date, partner_id, partner_type, amount){
  if(!client) throw new Error('Init client first');
  const { data, error } = await client.rpc('post_payment', { p_payment_id: payment_id, p_payment_date: payment_date, p_partner_id: partner_id, p_partner_type: partner_type, p_amount: amount });
  if(error) throw error;
  log('RPC post_payment OK: ' + payment_id);
  return data;
}

async function rpc_postBill(bill_id, bill_date, supplier_id, amount){
  if(!client) throw new Error('Init client first');
  const { data, error } = await client.rpc('post_bill', { p_bill_id: bill_id, p_bill_date: bill_date, p_supplier_id: supplier_id, p_amount: amount });
  if(error) throw error;
  log('RPC post_bill OK: ' + bill_id);
  return data;
}

async function rpc_allocatePayment(payment_id, allocationsArray){
  if(!client) throw new Error('Init client first');
  const { data, error } = await client.rpc('allocate_payment_atomic', { p_payment_id: payment_id, p_allocations: JSON.stringify(allocationsArray) });
  if(error) throw error;
  log('RPC allocate OK: ' + payment_id);
  return data;
}

/* =========================
   AUTH
   ========================= */
function wireAuth(){
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const btnSignup = document.getElementById('btn-signup');
  const btnSignin = document.getElementById('btn-signin');
  const btnSignout = document.getElementById('btn-signout');

  btnSignup.onclick = async () => {
    if(!client) return alert('Initialize client first');
    const email = emailEl.value.trim(), password = passEl.value.trim();
    if(!email || !password) return alert('Enter email and password');
    const { data, error } = await client.auth.signUp({ email, password });
    if(error){ alert(error.message); log('Sign-up error: ' + error.message); return; }
    alert('Account created — check email to confirm.');
    log('Sign-up triggered for ' + email);
  };

  btnSignin.onclick = async () => {
    if(!client) return alert('Initialize client first');
    const email = emailEl.value.trim(), password = passEl.value.trim();
    if(!email || !password) return alert('Enter email and password');
    const { data, error } = await client.auth.signInWithPassword({ email, password });
    if(error){ alert(error.message); log('Sign-in error: ' + error.message); return; }
    log('Signed in as ' + data.user.email);
    setUserUI(data.user);
  };

  btnSignout.onclick = async () => {
    if(!client) return;
    await client.auth.signOut();
    setUserUI(null);
    log('Signed out');
  };

  client.auth.onAuthStateChange((event, session) => {
    if(session && session.user) setUserUI(session.user);
    else setUserUI(null);
  });

  function setUserUI(user){
    const info = document.getElementById('auth-info');
    if(user){
      info.textContent = 'Signed in as ' + user.email;
      document.getElementById('btn-signout').classList.remove('hidden');
      document.getElementById('btn-signin').classList.add('hidden');
      document.getElementById('btn-signup').classList.add('hidden');
    } else {
      info.textContent = 'Not signed in';
      document.getElementById('btn-signout').classList.add('hidden');
      document.getElementById('btn-signin').classList.remove('hidden');
      document.getElementById('btn-signup').classList.remove('hidden');
    }
  }
}

/* =========================
   CUSTOMERS
   ========================= */
async function loadCustomers(){
  if(!client) return;
  try{
    const { data } = await client.from('customers').select('*').order('customer_id');
    const div = document.getElementById('customers-list');
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No customers yet.</div>'; return; }
    let html = '<table><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody>';
    data.forEach(c=> html += `<tr><td class="mono">${c.customer_id}</td><td>${c.name}</td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;

    // update dropdowns
    const invSel = document.getElementById('inv-customer');
    const paySel = document.getElementById('pay-customer');
    invSel.innerHTML = '<option value="">Choose customer</option>';
    paySel.innerHTML = '<option value="">Partner</option>';
    data.forEach(c=>{
      invSel.add(new Option(`${c.customer_id} — ${c.name}`, c.customer_id));
      paySel.add(new Option(`${c.customer_id} — ${c.name}`, c.customer_id));
    });
  }catch(e){ log('Load customers error: ' + e.message); }
}

document.getElementById('btn-add-customer').onclick = async ()=>{
  if(!client) return alert('Init client');
  const id = document.getElementById('cust-id').value.trim();
  const name = document.getElementById('cust-name').value.trim();
  if(!id || !name) return alert('Provide id and name');
  const { error } = await client.from('customers').insert([{ customer_id:id, name }]);
  if(error) { alert(error.message); log('Add customer error: ' + error.message); return; }
  log('Customer added: ' + id);
  document.getElementById('cust-id').value=''; document.getElementById('cust-name').value='';
  loadCustomers(); refreshDashboard();
};

/* =========================
   INVOICES (call RPC)
   ========================= */
async function loadInvoices(){
  if(!client) return;
  try{
    const { data } = await client.from('sales_invoices').select('*').order('invoice_date',{ascending:false});
    const div = document.getElementById('invoices-list');
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No invoices yet.</div>'; return; }
    let html = '<table><thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Total</th><th>Residual</th></tr></thead><tbody>';
    data.forEach(i=> html += `<tr><td class="mono">${i.invoice_id}</td><td>${i.invoice_date}</td><td>${i.customer_id}</td><td>${i.total_amount}</td><td>${i.residual}</td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('Load invoices err: ' + e.message); }
}

document.getElementById('btn-add-invoice').onclick = async ()=>{
  if(!client) return alert('Init client');
  const invoice_id = document.getElementById('inv-id').value.trim();
  const invoice_date = document.getElementById('inv-date').value;
  const customer_id = document.getElementById('inv-customer').value;
  const amount = parseFloat(document.getElementById('inv-amount').value || '0');
  if(!invoice_id || !invoice_date || !customer_id || !amount) return alert('Fill invoice fields');
  try{
    await rpc_postInvoice(invoice_id, invoice_date, customer_id, amount);
    document.getElementById('inv-id').value=''; document.getElementById('inv-amount').value='';
    await loadInvoices(); await loadJournalEntries(); refreshDashboard();
  }catch(e){
    alert(e.message || 'RPC error');
    log('RPC post invoice failed: ' + (e.message||e));
  }
};

/* Export invoice PDF (simple) */
document.getElementById('btn-export-invoice').onclick = async ()=>{
  const invoice_id = prompt('Enter invoice id to export as PDF');
  if(!invoice_id) return;
  try{
    const { data: inv } = await client.from('sales_invoices').select('*').eq('invoice_id', invoice_id).single();
    if(!inv) return alert('Invoice not found');
    // build a simple HTML snapshot
    const container = document.createElement('div');
    container.style.width = '800px';
    container.style.padding = '20px';
    container.style.background = '#fff';
    container.innerHTML = `<h2>Invoice ${inv.invoice_id}</h2>
      <p>Date: ${inv.invoice_date}</p>
      <p>Customer: ${inv.customer_id}</p>
      <p>Total: ${inv.total_amount}</p>
      <p>Residual: ${inv.residual}</p>`;
    document.body.appendChild(container);
    const canvas = await html2canvas(container);
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'px', format: [canvas.width, canvas.height] });
    pdf.addImage(imgData, 'PNG', 0, 0);
    pdf.save('invoice-' + invoice_id + '.pdf');
    container.remove();
    log('Invoice exported: ' + invoice_id);
  }catch(e){ alert(e.message||'Export error'); log('Export invoice err: ' + e.message); }
};

/* =========================
   PAYMENTS (RPC)
   ========================= */
async function loadPayments(){
  if(!client) return;
  try{
    const { data } = await client.from('payments').select('*').order('payment_date',{ascending:false});
    const div = document.getElementById('payments-list');
    const allocSel = document.getElementById('alloc-payment');
    allocSel.innerHTML = '<option value="">Select payment</option>';
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No payments yet.</div>'; return; }
    let html = '<table><thead><tr><th>ID</th><th>Date</th><th>Partner</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
    data.forEach(p=>{
      html += `<tr><td class="mono">${p.payment_id}</td><td>${p.payment_date}</td><td>${p.partner_id}</td><td>${p.amount}</td><td>${p.status}</td></tr>`;
      allocSel.add(new Option(`${p.payment_id} — ${p.partner_id} — ${p.amount}`, p.payment_id));
    });
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('Load payments err: ' + e.message); }
}

document.getElementById('btn-add-payment').onclick = async ()=>{
  if(!client) return alert('Init client');
  const payment_id = document.getElementById('pay-id').value.trim();
  const payment_date = document.getElementById('pay-date').value;
  const partner_id = document.getElementById('pay-customer').value;
  const amount = parseFloat(document.getElementById('pay-amount').value || '0');
  const partner_type = document.getElementById('pay-type').value || 'Customer';
  if(!payment_id || !payment_date || !partner_id || !amount) return alert('Fill payment fields');
  try{
    await rpc_postPayment(payment_id, payment_date, partner_id, partner_type, amount);
    document.getElementById('pay-id').value=''; document.getElementById('pay-amount').value='';
    loadPayments(); loadJournalEntries(); refreshDashboard();
  }catch(e){ alert(e.message||'RPC error'); log('RPC post payment failed: ' + (e.message||e)); }
};

/* Allocation UI */
document.getElementById('btn-load-invoices').onclick = async ()=>{
  const paymentId = document.getElementById('alloc-payment').value;
  if(!paymentId) return alert('Select payment first');
  try{
    const { data:pay } = await client.from('payments').select('*').eq('payment_id', paymentId).single();
    const { data: invoices } = await client.from('sales_invoices').select('*').eq('customer_id', pay.partner_id).neq('residual', 0).order('invoice_date');
    const div = document.getElementById('alloc-invoices');
    if(!invoices || invoices.length===0){ div.innerHTML = '<div class="small muted">No open invoices</div>'; return; }
    let html = '<table><thead><tr><th>Invoice</th><th>Residual</th><th>Allocate</th></tr></thead><tbody>';
    invoices.forEach(inv=> html += `<tr><td class="mono">${inv.invoice_id}</td><td>${inv.residual}</td><td><input class="alloc-input" data-inv="${inv.invoice_id}" type="number" step="0.01" max="${inv.residual}"></td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('Load invoices for allocation err: ' + e.message); }
};

document.getElementById('btn-apply-allocation').onclick = async ()=>{
  const paymentId = document.getElementById('alloc-payment').value;
  if(!paymentId) return alert('Select payment first');
  const inputs = Array.from(document.querySelectorAll('.alloc-input'));
  const allocations = [];
  let totalAlloc = 0;
  for(const inp of inputs){
    const amt = parseFloat(inp.value || '0');
    if(amt > 0){ allocations.push({ invoice_id: inp.dataset.inv, allocated_amount: amt }); totalAlloc += amt; }
  }
  if(allocations.length===0) return alert('Enter allocation amounts');
  try{
    await rpc_allocatePayment(paymentId, allocations);
    log('Allocations applied via RPC');
    loadInvoices(); loadPayments(); refreshDashboard(); loadJournalEntries(); 
  }catch(e){ alert(e.message||'RPC allocate error'); log('RPC allocate failed: ' + (e.message||e)); }
};

/* =========================
   PURCHASES (RPC)
   ========================= */
async function loadBills(){
  if(!client) return;
  try{
    const { data } = await client.from('purchase_bills').select('*').order('bill_date',{ascending:false});
    const div = document.getElementById('bills-list');
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No bills yet.</div>'; return; }
    let html = '<table><thead><tr><th>Bill</th><th>Date</th><th>Supplier</th><th>Total</th><th>Residual</th></tr></thead><tbody>';
    data.forEach(b=> html += `<tr><td class="mono">${b.bill_id}</td><td>${b.bill_date}</td><td>${b.supplier_id}</td><td>${b.total_amount}</td><td>${b.residual}</td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('Load bills err: ' + e.message); }
}

document.getElementById('btn-add-bill').onclick = async ()=>{
  if(!client) return alert('Init client');
  const bill_id = document.getElementById('bill-id').value.trim();
  const bill_date = document.getElementById('bill-date').value;
  const supplier_id = document.getElementById('supplier-id').value.trim();
  const amount = parseFloat(document.getElementById('bill-amount').value || '0');
  if(!bill_id || !bill_date || !supplier_id || !amount) return alert('Fill bill fields');
  try{
    await rpc_postBill(bill_id, bill_date, supplier_id, amount);
    document.getElementById('bill-id').value=''; document.getElementById('bill-amount').value='';
    loadBills(); loadJournalEntries(); refreshDashboard();
  }catch(e){ alert(e.message||'RPC error'); log('RPC post bill failed: ' + (e.message||e)); }
};

document.getElementById('btn-add-supp-payment').onclick = async ()=>{
  if(!client) return alert('Init client');
  const payId = document.getElementById('supplier-pay-id').value.trim();
  const payDate = document.getElementById('supplier-pay-date').value;
  const billSel = document.getElementById('supplier-select').value;
  const amount = parseFloat(document.getElementById('supplier-pay-amount').value || '0');
  if(!payId || !payDate || !billSel || !amount) return alert('Fill supplier payment fields');
  try{
    await rpc_postPayment(payId, payDate, billSel, 'Supplier', amount);
    loadPayments(); loadJournalEntries(); refreshDashboard();
  }catch(e){ alert(e.message||'RPC error'); log('RPC supplier payment failed: ' + (e.message||e)); }
};

/* =========================
   PRODUCTS
   ========================= */
async function loadProducts(){
  if(!client) return;
  try{
    const { data } = await client.from('products').select('*').order('sku');
    const div = document.getElementById('products-list');
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No products yet.</div>'; return; }
    let html = '<table><thead><tr><th>SKU</th><th>Description</th><th>Price</th></tr></thead><tbody>';
    data.forEach(p=> html += `<tr><td class="mono">${p.sku}</td><td>${p.description}</td><td>${p.unit_price}</td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('Load products err: ' + e.message); }
}
document.getElementById('btn-add-prod')?.addEventListener('click', async ()=>{
  if(!client) return;
  const sku = document.getElementById('prod-sku').value.trim();
  const name = document.getElementById('prod-name').value.trim();
  const price = parseFloat(document.getElementById('prod-price').value || '0');
  if(!sku || !name) return alert('Fill product fields');
  await client.from('products').insert([{ sku, description:name, unit_price:price }]);
  log('Product added: ' + sku);
  document.getElementById('prod-sku').value=''; document.getElementById('prod-name').value=''; document.getElementById('prod-price').value='';
  loadProducts();
});

/* =========================
   COA / Journal Entries / Trial Balance
   ========================= */
async function loadCOA(){
  if(!client) return;
  try{
    const { data } = await client.from('chart_of_accounts').select('*').order('account_code');
    const div = document.getElementById('coa-list');
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No chart of accounts found.</div>'; return; }
    let html = '<table><thead><tr><th>Code</th><th>Name</th><th>Type</th></tr></thead><tbody>';
    data.forEach(r=> html += `<tr><td class="mono">${r.account_code}</td><td>${r.account_name}</td><td>${r.account_type}</td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('Load COA err: ' + e.message); }
}

async function loadJournalEntries(){
  if(!client) return;
  try{
    const { data } = await client.from('journal_entries').select('*').order('je_date',{ascending:false}).limit(500);
    const div = document.getElementById('je-list');
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No journal entries</div>'; return; }
    let html = '<table><thead><tr><th>JE</th><th>Date</th><th>Account</th><th>Partner</th><th>Debit</th><th>Credit</th></tr></thead><tbody>';
    data.forEach(r=> html += `<tr><td class="mono">${r.je_id}</td><td>${r.je_date}</td><td>${r.account_code}</td><td>${r.partner_id||''}</td><td>${r.debit||0}</td><td>${r.credit||0}</td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('JE render err: ' + e.message); }
}

async function loadTrialBalance(){
  if(!client) return;
  try{
    const { data } = await client.from('trial_balance').select('*').order('account_code');
    const div = document.getElementById('trial-list');
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No TB rows</div>'; return; }
    let html = '<table><thead><tr><th>Account</th><th>Name</th><th>Debit</th><th>Credit</th><th>Balance</th></tr></thead><tbody>';
    data.forEach(r=> html += `<tr><td class="mono">${r.account_code}</td><td>${r.account_name}</td><td>${r.debit_total||0}</td><td>${r.credit_total||0}</td><td>${r.balance||0}</td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('TB load err: ' + e.message); }
}
document.getElementById('btn-load-trial')?.addEventListener('click', loadTrialBalance);

/* =========================
   Dashboard KPIs & Reports
   ========================= */
async function refreshDashboard(){
  if(!client) return;
  try{
    const yyyy = new Date().getFullYear();
    const mm = String(new Date().getMonth()+1).padStart(2,'0');
    const monthStart = `${yyyy}-${mm}-01`;
    const { data:invoices } = await client.from('sales_invoices').select('total_amount').gte('invoice_date', monthStart);
    const sumSales = (invoices||[]).reduce((s,r)=>s + Number(r.total_amount||0),0);
    document.getElementById('dash-sales').textContent = sumSales.toFixed(2);

    const { data:payments } = await client.from('payments').select('amount').gte('payment_date', monthStart);
    const sumPayments = (payments||[]).reduce((s,r)=>s + Number(r.amount||0),0);
    document.getElementById('dash-collections').textContent = sumPayments.toFixed(2);

    const { data:ar } = await client.from('sales_invoices').select('residual');
    const arSum = (ar||[]).reduce((s,r)=>s + Number(r.residual||0),0);
    document.getElementById('dash-ar').textContent = arSum.toFixed(2);
  }catch(e){ log('Dashboard error: ' + e.message); }
}

/* AR Aging (report) */
document.getElementById('btn-ar-aging').onclick = async ()=>{
  if(!client) return;
  try{
    const { data } = await client.rpc('ar_aging_report'); // optional if you create RPC; else use client.sql approach
    // fallback if RPC not present
    if(!data){
      const { data: rows } = await client.rpc('ar_aging_report').catch(()=>null);
    }
    // If no server RPC, do simple bucket client-side:
    const { data: invoices } = await client.from('sales_invoices').select('invoice_id,invoice_date,residual');
    const buckets = {'0-30':0,'31-60':0,'61-90':0,'90+':0};
    const today = new Date();
    invoices.forEach(inv=>{
      const invDate = new Date(inv.invoice_date);
      const diffDays = Math.floor((today - invDate)/(1000*60*60*24));
      if(diffDays <= 30) buckets['0-30'] += Number(inv.residual||0);
      else if(diffDays <= 60) buckets['31-60'] += Number(inv.residual||0);
      else if(diffDays <= 90) buckets['61-90'] += Number(inv.residual||0);
      else buckets['90+'] += Number(inv.residual||0);
    });
    document.getElementById('reports-area').innerHTML = '<pre>' + JSON.stringify(buckets, null, 2) + '</pre>';
    log('AR aging loaded (client-side)');
  }catch(e){ log('AR aging err: ' + e.message); }
};

/* Sales this month quick report */
document.getElementById('btn-sales-report').onclick = async ()=>{
  if(!client) return;
  try{
    const yyyy = new Date().getFullYear(); const mm = String(new Date().getMonth()+1).padStart(2,'0');
    const monthStart = `${yyyy}-${mm}-01`;
    const { data } = await client.from('sales_invoices').select('invoice_id,total_amount').gte('invoice_date', monthStart);
    document.getElementById('reports-area').innerHTML = '<pre>' + JSON.stringify(data||[], null, 2) + '</pre>';
    log('Sales report loaded');
  }catch(e){ log('Sales report err: ' + e.message); }
};

/* =========================
   Company profile
   ========================= */
document.getElementById('btn-save-company').onclick = async ()=>{
  if(!client) return alert('Init client');
  const payload = {
    id: 1,
    company_name: document.getElementById('company-name').value.trim(),
    pin: document.getElementById('company-pin').value.trim(),
    email: document.getElementById('company-email').value.trim(),
    phone: document.getElementById('company-phone').value.trim(),
    address: document.getElementById('company-address').value.trim(),
    logo_url: document.getElementById('company-logo').value.trim()
  };
  try{
    await client.from('company_profile').upsert([payload], { onConflict:['id'] });
    log('Company profile saved');
    alert('Company profile saved');
  }catch(e){ log('Save company err: ' + e.message); alert(e.message); }
};
document.getElementById('btn-load-company').onclick = loadCompanyProfile;
async function loadCompanyProfile(){
  if(!client) return;
  try{
    const { data } = await client.from('company_profile').select('*').limit(1).single();
    if(!data) return;
    document.getElementById('company-name').value = data.company_name || '';
    document.getElementById('company-pin').value = data.pin || '';
    document.getElementById('company-email').value = data.email || '';
    document.getElementById('company-phone').value = data.phone || '';
    document.getElementById('company-address').value = data.address || '';
    document.getElementById('company-logo').value = data.logo_url || '';
    log('Company profile loaded');
  }catch(e){ log('Load company err: ' + e.message); }
}

/* =========================
   Bank Reconciliation (basic)
   ========================= */
document.getElementById('btn-create-recon').onclick = async ()=>{
  if(!client) return;
  const bank = document.getElementById('rec-bank-account').value.trim();
  const date = document.getElementById('rec-date').value;
  const balance = parseFloat(document.getElementById('rec-statement-balance').value || '0');
  if(!bank || !date) return alert('Provide bank and date');
  try{
    const { data, error } = await client.from('bank_reconciliations').insert([{ bank_account: bank, bank_date: date, statement_balance: balance }]);
    if(error) throw error;
    log('Bank reconciliation created id: ' + data[0].id);
    loadReconciliations();
  }catch(e){ log('Create recon err: ' + e.message); alert(e.message); }
};

async function loadReconciliations(){
  if(!client) return;
  try{
    const { data } = await client.from('bank_reconciliations').select('*').order('created_at',{ascending:false});
    const div = document.getElementById('recon-list');
    if(!data || data.length===0){ div.innerHTML = '<div class="small muted">No reconciliations</div>'; return; }
    let html = '<table><thead><tr><th>ID</th><th>Bank</th><th>Date</th><th>Balance</th><th>Reconciled</th></tr></thead><tbody>';
    data.forEach(r=> html += `<tr><td class="mono">${r.id}</td><td>${r.bank_account}</td><td>${r.bank_date}</td><td>${r.statement_balance}</td><td>${r.reconciled}</td></tr>`);
    html += '</tbody></table>';
    div.innerHTML = html;
  }catch(e){ log('Load recon err: ' + e.message); }
}

/* =========================
   Initialization periodic refresh
   ========================= */
setInterval(()=>{ if(client){ loadCustomers(); loadInvoices(); loadPayments(); loadBills(); loadProducts(); loadCOA(); loadJournalEntries(); loadTrialBalance(); refreshDashboard(); } }, 45000);

</script>
</body>
</html>
