<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Simple Accounting ERP (Supabase) — Starter UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Supabase JS (v2) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:20px; background:#f5f7fb}
    header{display:flex; gap:12px; align-items:center; margin-bottom:18px}
    .card{background:white;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(20,20,50,.06); margin-bottom:14px}
    input, select, button, textarea{padding:8px;border-radius:6px;border:1px solid #d8dde6; font-size:14px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee; text-align:left}
    .grid{display:grid;grid-template-columns:1fr 320px; gap:14px}
    .small{font-size:13px;color:#666}
    .danger{color:#c0392b}
    .success{color:#169e16}
    .muted{color:#7b8591;font-size:13px}
    .right{float:right}
    .row{display:flex;gap:8px;align-items:center}
    .mono{font-family:monospace;background:#f2f6fb;padding:4px 8px;border-radius:6px}
    .hidden{display:none}
  </style>
</head>
<body>

<header>
  <h2>Starter Accounting ERP — Web UI</h2>
  <div id="auth-info" class="muted"></div>
</header>

<div class="grid">
  <div>
    <!-- AUTH -->
    <div id="auth" class="card">
      <h3>Sign up / Sign in</h3>
      <div id="auth-forms">
        <div class="row">
          <input id="email" placeholder="Email" />
          <input id="password" placeholder="Password" type="password" />
          <button id="btn-signup">Sign up</button>
          <button id="btn-signin">Sign in</button>
        </div>
        <div class="small muted" style="margin-top:8px">
          Use a real email — Supabase will (optionally) send a confirmation. This demo uses the anon key so treat data as public unless you add RLS.
        </div>
      </div>
      <div id="auth-actions" class="hidden">
        <div class="row">
          <button id="btn-signout">Sign out</button>
          <button id="btn-refresh">Refresh data</button>
        </div>
      </div>
    </div>

    <!-- CUSTOMERS -->
    <div class="card">
      <h3>Customers</h3>
      <div class="row">
        <input id="cust-id" placeholder="Customer ID (e.g., C0001)"/>
        <input id="cust-name" placeholder="Customer name"/>
        <button id="btn-add-customer">Add</button>
      </div>
      <div id="customers-list" style="margin-top:10px"></div>
    </div>

    <!-- SALES INVOICES -->
    <div class="card">
      <h3>Sales Invoices</h3>
      <div class="row">
        <input id="inv-id" placeholder="Invoice ID (INV-2025-0001)"/>
        <input id="inv-date" type="date"/>
        <select id="inv-customer"><option value="">Choose customer...</option></select>
        <input id="inv-amount" placeholder="Total amount" type="number" />
        <button id="btn-add-invoice">Create Invoice</button>
      </div>
      <div id="invoices-list" style="margin-top:10px"></div>
    </div>

    <!-- PAYMENTS -->
    <div class="card">
      <h3>Payments</h3>
      <div class="row">
        <input id="pay-id" placeholder="Payment ID (PAY-001)"/>
        <input id="pay-date" type="date"/>
        <select id="pay-customer"><option value="">Partner...</option></select>
        <input id="pay-amount" placeholder="Amount" type="number" />
        <select id="pay-type"><option value="Customer">Customer</option><option value="Supplier">Supplier</option></select>
        <button id="btn-add-payment">Record Payment</button>
      </div>
      <small class="muted">Record a payment first, then allocate it to invoices using the allocation tool.</small>

      <div id="payments-list" style="margin-top:10px"></div>
    </div>

    <!-- ALLOCATIONS -->
    <div class="card">
      <h3>Allocate Payment (split across invoices)</h3>
      <div class="row">
        <select id="alloc-payment"><option value="">Select payment...</option></select>
        <button id="btn-load-invoices">Load open invoices</button>
      </div>

      <div id="alloc-invoices" style="margin-top:8px"></div>
      <div style="margin-top:8px" class="row">
        <button id="btn-apply-allocation">Apply Allocation</button>
        <div id="alloc-status" class="muted"></div>
      </div>
    </div>

    <!-- TRIAL BALANCE -->
    <div class="card">
      <h3>Trial Balance</h3>
      <div>
        <button id="btn-load-trial">Refresh Trial Balance</button>
      </div>
      <div id="trial-list" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- RIGHT COLUMN: Quick actions & logs -->
  <aside>
    <div class="card">
      <h3>Quick tools</h3>
      <div class="small">Supabase config (paste your values below)</div>
      <div style="margin-top:8px">
        <input id="supabase-url" placeholder="SUPABASE_URL" class="mono" style="width:100%"/>
        <input id="supabase-key" placeholder="SUPABASE_ANON_KEY" class="mono" style="width:100%; margin-top:8px"/>
        <button id="btn-init" style="margin-top:8px">Initialize client</button>
      </div>
      <div style="margin-top:8px">
        <div><strong>Notes</strong></div>
        <div class="muted small">
          • Use the project anon key for testing. <br>
          • For production, secure with RLS and use server functions for sensitive ops. <br>
          • This demo assumes tables: <span class="mono">customers, sales_invoices, payments, allocations</span> and view <span class="mono">trial_balance</span>.
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Log / Messages</h3>
      <pre id="log" style="height:300px;overflow:auto;background:#fbfdff;border-radius:6px;padding:8px"></pre>
    </div>
  </aside>
</div>

<script>
/* ============================
   Starter ERP UI (Supabase)
   ============================
   Paste your SUPABASE_URL and SUPABASE_ANON_KEY in the inputs on the right,
   then press "Initialize client". The UI will talk to these tables:
   - customers
   - sales_invoices
   - payments
   - allocations
   - trial_balance (view)
*/

/* ---------- Helpers & state ---------- */
let supabase = null;
const logEl = document.getElementById('log');
function log(msg, err=false){
  const time = new Date().toLocaleTimeString();
  logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
  if(err) console.error(msg);
}
function money(n){ return Number(n||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }

/* ---------- Init client ---------- */
document.getElementById('btn-init').addEventListener('click', async ()=>{
  const url = document.getElementById('supabase-url').value.trim();
  const key = document.getElementById('supabase-key').value.trim();
  if(!url || !key){ alert('Provide SUPABASE_URL and SUPABASE_ANON_KEY'); return; }
  supabase = supabaseJs.createClient(url, key);
  log('Supabase client initialized');
  await tryFetchBasic();
  showAuthUI();
});

/* ---------- Auth (simple email/password) ---------- */
document.getElementById('btn-signup').addEventListener('click', async ()=>{
  if(!supabase){ alert('Initialize client first'); return; }
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  if(!email || !password){ alert('Email & password required'); return; }
  const { data, error } = await supabase.auth.signUp({ email, password });
  if(error) { log('Sign up error: ' + error.message, true); alert(error.message); return; }
  log('Sign up successful. Check email for confirmation if required.');
});
document.getElementById('btn-signin').addEventListener('click', async ()=>{
  if(!supabase){ alert('Initialize client first'); return; }
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){ log('Sign in error: ' + error.message, true); alert(error.message); return; }
  log('Signed in as ' + (data.user?.email || 'unknown'));
  showAuthUI();
});
document.getElementById('btn-signout').addEventListener('click', async ()=>{
  if(!supabase) return;
  await supabase.auth.signOut();
  log('Signed out');
  showAuthUI();
});
async function showAuthUI(){
  const user = supabase ? supabase.auth.getUser().then(r=>r.data.user).catch(()=>null) : null;
  let u;
  try{ u = await (user); } catch(e){ u = null; }
  if(u){
    document.getElementById('auth-forms').classList.add('hidden');
    document.getElementById('auth-actions').classList.remove('hidden');
    document.getElementById('auth-info').textContent = 'Signed in as ' + (u.email || u.id);
  } else {
    document.getElementById('auth-forms').classList.remove('hidden');
    document.getElementById('auth-actions').classList.add('hidden');
    document.getElementById('auth-info').textContent = 'Not signed in';
  }
}

/* ---------- Basic fetch to confirm tables exist ---------- */
async function tryFetchBasic(){
  try{
    const { data, error } = await supabase.from('customers').select('*').limit(1);
    if(error){ log('Table check error: ' + error.message, true); }
    else log('Connected and found customers table (ok)');
    // populate dropdowns
    await loadCustomersIntoSelects();
    await loadPaymentsSelect();
  }catch(e){
    log('Connection/test failed: ' + e.message, true);
  }
}

/* ---------- Customers ---------- */
document.getElementById('btn-add-customer').addEventListener('click', async ()=>{
  const id = document.getElementById('cust-id').value.trim();
  const name = document.getElementById('cust-name').value.trim();
  if(!id || !name) return alert('Provide id and name');
  const payload = { customer_id: id, name };
  const { data, error } = await supabase.from('customers').insert([payload]);
  if(error){ log('Add customer error: ' + error.message, true); alert(error.message); return; }
  log('Customer added: ' + id);
  document.getElementById('cust-id').value=''; document.getElementById('cust-name').value='';
  await loadCustomersIntoSelects();
  await listCustomers();
});
async function loadCustomersIntoSelects(){
  const { data, error } = await supabase.from('customers').select('*').order('customer_id', {ascending:true});
  const invCust = document.getElementById('inv-customer');
  const payCust = document.getElementById('pay-customer');
  invCust.innerHTML = '<option value="">Choose customer...</option>';
  payCust.innerHTML = '<option value="">Partner...</option>';
  if(error){ log('Load customers error: ' + error.message, true); return; }
  data.forEach(c=>{
    const o = document.createElement('option');
    o.value = c.customer_id;
    o.textContent = c.customer_id + ' — ' + c.name;
    invCust.appendChild(o);
    const p = document.createElement('option');
    p.value = c.customer_id;
    p.textContent = c.customer_id + ' — ' + c.name;
    payCust.appendChild(p);
  });
  await listCustomers();
}
async function listCustomers(){
  const { data, error } = await supabase.from('customers').select('*').order('customer_id');
  const div = document.getElementById('customers-list');
  if(error){ div.innerHTML = '<div class="danger">Error loading customers</div>'; return; }
  if(!data || data.length===0){ div.innerHTML = '<div class="muted">No customers yet</div>'; return; }
  let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Phone</th></tr></thead><tbody>';
  data.forEach(r => html += `<tr><td class="mono">${r.customer_id}</td><td>${r.name}</td><td class="small">${r.phone||''}</td></tr>`);
  html += '</tbody></table>';
  div.innerHTML = html;
}

/* ---------- Sales Invoices ---------- */
document.getElementById('btn-add-invoice').addEventListener('click', async ()=>{
  const invoice_id = document.getElementById('inv-id').value.trim();
  const invoice_date = document.getElementById('inv-date').value;
  const customer_id = document.getElementById('inv-customer').value;
  const total_amount = parseFloat(document.getElementById('inv-amount').value || 0);
  if(!invoice_id || !invoice_date || !customer_id) return alert('Invoice id, date, customer required');
  const payload = { invoice_id, invoice_date, customer_id, due_date:invoice_date, status:'Posted', total_amount, residual: total_amount };
  const { data, error } = await supabase.from('sales_invoices').insert([payload]);
  if(error){ log('Create invoice error: ' + error.message, true); alert(error.message); return; }
  log('Invoice created: ' + invoice_id + ' (' + money(total_amount) + ')');
  document.getElementById('inv-id').value=''; document.getElementById('inv-amount').value='';
  await listInvoices();
});
async function listInvoices(){
  const { data, error } = await supabase.from('sales_invoices').select('*').order('invoice_date', {ascending:false}).limit(100);
  const div = document.getElementById('invoices-list');
  if(error){ div.innerHTML = '<div class="danger">Error loading invoices</div>'; log(error.message, true); return; }
  if(!data || data.length===0){ div.innerHTML = '<div class="muted">No invoices</div>'; return; }
  let html = '<table><thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Total</th><th>Residual</th><th>Status</th></tr></thead><tbody>';
  data.forEach(r => html += `<tr><td class="mono">${r.invoice_id}</td><td>${r.invoice_date}</td><td>${r.customer_id}</td><td>${money(r.total_amount)}</td><td>${money(r.residual)}</td><td>${r.status}</td></tr>`);
  html += '</tbody></table>';
  div.innerHTML = html;
}

/* ---------- Payments ---------- */
document.getElementById('btn-add-payment').addEventListener('click', async ()=>{
  const payment_id = document.getElementById('pay-id').value.trim();
  const payment_date = document.getElementById('pay-date').value;
  const partner_id = document.getElementById('pay-customer').value;
  const partner_type = document.getElementById('pay-type').value;
  const amount = parseFloat(document.getElementById('pay-amount').value || 0);
  if(!payment_id || !payment_date || !partner_id || !amount) return alert('Provide payment id, date, partner and amount');
  const payload = { payment_id, payment_date, partner_id, partner_type, amount, journal: 'Bank', status: 'Unallocated' };
  const { data, error } = await supabase.from('payments').insert([payload]);
  if(error){ log('Create payment error: ' + error.message, true); alert(error.message); return; }
  log('Payment recorded: ' + payment_id + ' (' + money(amount) + ')');
  document.getElementById('pay-id').value=''; document.getElementById('pay-amount').value='';
  await listPayments();
  await loadPaymentsSelect();
});
async function listPayments(){
  const { data, error } = await supabase.from('payments').select('*').order('payment_date', {ascending:false}).limit(100);
  const div = document.getElementById('payments-list');
  if(error){ div.innerHTML = '<div class="danger">Error loading payments</div>'; return; }
  if(!data || data.length===0){ div.innerHTML = '<div class="muted">No payments</div>'; return; }
  let html = '<table><thead><tr><th>Payment</th><th>Date</th><th>Partner</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
  data.forEach(r => html += `<tr><td class="mono">${r.payment_id}</td><td>${r.payment_date}</td><td>${r.partner_id}</td><td>${money(r.amount)}</td><td>${r.status}</td></tr>`);
  html += '</tbody></table>';
  div.innerHTML = html;
}
async function loadPaymentsSelect(){
  const { data, error } = await supabase.from('payments').select('*').order('payment_date', {ascending:false}).limit(200);
  const sel = document.getElementById('alloc-payment');
  sel.innerHTML = '<option value="">Select payment...</option>';
  if(!data || data.length===0) return;
  data.forEach(p=>{
    const o = document.createElement('option');
    o.value = p.payment_id;
    o.textContent = `${p.payment_id} — ${p.partner_id} — ${money(p.amount)} (${p.status})`;
    sel.appendChild(o);
  });
}

/* ---------- Allocation UI & Logic ----------
   This builds a small list of open invoices and lets user input allocation amounts.
*/
document.getElementById('btn-load-invoices').addEventListener('click', async ()=>{
  const paymentId = document.getElementById('alloc-payment').value;
  if(!paymentId) return alert('Select a payment first');
  // load payment info
  const { data:payData, error:payErr } = await supabase.from('payments').select('*').eq('payment_id', paymentId).single();
  if(payErr) { alert(payErr.message); return; }
  // load open invoices for that partner
  const { data:invData, error:invErr } = await supabase.from('sales_invoices').select('*').eq('customer_id', payData.partner_id).gte('residual', 0).order('invoice_date', {ascending:true}).limit(200);
  if(invErr) { alert(invErr.message); return; }

  const container = document.getElementById('alloc-invoices');
  if(!invData || invData.length===0){ container.innerHTML = '<div class="muted">No invoices for this partner</div>'; return; }

  // build UI rows with input boxes for allocation amounts
  let html = '<table><thead><tr><th>Invoice</th><th>Total</th><th>Residual</th><th>Allocate</th></tr></thead><tbody>';
  invData.forEach(inv => {
    html += `<tr>
      <td class="mono">${inv.invoice_id}</td>
      <td>${money(inv.total_amount)}</td>
      <td>${money(inv.residual)}</td>
      <td><input type="number" class="alloc-input" data-inv="${inv.invoice_id}" data-res="${inv.residual}" min="0" max="${inv.residual}" step="0.01" style="width:120px" /></td>
    </tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
  // prefill first allocations to show simple example (not mandatory)
});

document.getElementById('btn-apply-allocation').addEventListener('click', async ()=>{
  const paymentId = document.getElementById('alloc-payment').value;
  if(!paymentId) return alert('Select payment first');
  // read allocation rows
  const inputs = Array.from(document.querySelectorAll('.alloc-input'));
  if(inputs.length===0) return alert('Load invoices first');
  const allocations = [];
  let totalAlloc = 0;
  for(const inp of inputs){
    const amt = parseFloat(inp.value || 0);
    if(amt > 0){
      const inv = inp.dataset.inv;
      allocations.push({ invoice_id: inv, allocated_amount: amt });
      totalAlloc += amt;
    }
  }
  if(allocations.length===0) return alert('Enter allocation amounts');
  // fetch payment to check amount
  const { data:pay, error:perr } = await supabase.from('payments').select('*').eq('payment_id', paymentId).single();
  if(perr){ alert(perr.message); return; }
  if(totalAlloc > Number(pay.amount) + 0.0001) return alert('Allocated amount exceeds payment amount');
  // Write allocation rows to DB
  const payload = allocations.map(a => ({
    allocation_id: paymentId + '-' + a.invoice_id,
    payment_id: paymentId,
    invoice_id: a.invoice_id,
    allocated_amount: a.allocated_amount,
    allocation_date: new Date().toISOString().slice(0,10)
  }));
  const { data, error } = await supabase.from('allocations').insert(payload);
  if(error){ alert('Insert allocations error: ' + error.message); log('Alloc insert error: ' + error.message, true); return; }
  log('Allocations saved: ' + payload.length + ' rows.');
  // Update invoice residuals in sales_invoices (simple approach: subtract allocations sum per invoice)
  // NOTE: This is a simple, synchronous approach for demo. For production, use DB functions/triggers to ensure atomicity.
  for(const a of allocations){
    // get existing residual
    const { data: invoice, error: invErr } = await supabase.from('sales_invoices').select('*').eq('invoice_id', a.invoice_id).single();
    if(invErr){ log('Invoice fetch error: ' + invErr.message, true); continue; }
    const newResidual = Number(invoice.residual) - Number(a.allocated_amount);
    const newStatus = (newResidual <= 0 ? 'Paid' : (newResidual < invoice.total_amount ? 'PartPaid' : invoice.status));
    await supabase.from('sales_invoices').update({ residual: newResidual, status: newStatus }).eq('invoice_id', a.invoice_id);
    log(`Invoice ${a.invoice_id} residual updated to ${money(newResidual)}`);
  }
  // Update payment status
  const { data:allocAgg } = await supabase.from('allocations').select('sum(allocated_amount)').eq('payment_id', paymentId);
  // Note: above REST does not support sum shorthand in all clients; as a fallback we can re-query allocations and sum in JS:
  const { data: allAllocRows } = await supabase.from('allocations').select('*').eq('payment_id', paymentId);
  const allocatedSum = (allAllocRows || []).reduce((s,r)=>s + Number(r.allocated_amount),0);
  let payStatus = 'PartAllocated';
  if(allocatedSum === 0) payStatus = 'Unallocated';
  else if(Math.abs(allocatedSum - Number(pay.amount)) < 0.005) payStatus = 'Allocated';
  await supabase.from('payments').update({ status: payStatus }).eq('payment_id', paymentId);
  log(`Payment ${paymentId} updated: allocated ${money(allocatedSum)} status ${payStatus}`);
  // refresh lists
  await listInvoices();
  await listPayments();
  await loadPaymentsSelect();
  document.getElementById('alloc-status').textContent = 'Allocation applied';
});

/* ---------- Trial balance ---------- */
document.getElementById('btn-load-trial').addEventListener('click', async ()=>{
  if(!supabase) return alert('Initialize client first');
  const { data, error } = await supabase.from('trial_balance').select('*').order('account_code');
  const div = document.getElementById('trial-list');
  if(error){ div.innerHTML = '<div class="danger">Error loading trial balance</div>'; log(error.message, true); return; }
  if(!data || data.length===0){ div.innerHTML = '<div class="muted">No trial balance rows</div>'; return; }
  let html = '<table><thead><tr><th>Account</th><th>Name</th><th>Type</th><th>Debit</th><th>Credit</th><th>Balance</th></tr></thead><tbody>';
  data.forEach(r => html += `<tr><td class="mono">${r.account_code}</td><td>${r.account_name}</td><td>${r.account_type}</td><td>${money(r.debit_total)}</td><td>${money(r.credit_total)}</td><td>${money(r.balance)}</td></tr>`);
  html += '</tbody></table>';
  div.innerHTML = html;
});

/* ---------- Start-up helpers ---------- */
async function initIfPossible(){
  // try to auto-init if user pasted keys in localstorage earlier
  const url = localStorage.getItem('supabase_url');
  const key = localStorage.getItem('supabase_key');
  if(url && key){
    document.getElementById('supabase-url').value = url;
    document.getElementById('supabase-key').value = key;
    document.getElementById('btn-init').click();
  }
}
initIfPossible();

</script>
</body>
</html>


