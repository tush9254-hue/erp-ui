<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Starter ERP (Supabase Auth Fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Load Supabase from ESM (no Edge warnings) -->
  <script type="module">
    import * as supabaseLib from "https://esm.sh/@supabase/supabase-js@2";
    window.SupabaseCreateClient = supabaseLib.createClient;
  </script>

  <style>
    body { font-family: Arial; margin:0; padding:20px; background:#f5f7fb; }
    .card{background:#fff; padding:14px; border-radius:10px; margin-bottom:14px; box-shadow:0 6px 16px rgba(0,0,0,.08);}
    .row{display:flex; gap:8px;}
    input,button,select{padding:8px; border:1px solid #ccc; border-radius:6px;}
    .grid{display:grid; grid-template-columns:1fr 320px; gap:14px;}
    table{width:100%; border-collapse:collapse; margin-top:8px;}
    th,td{padding:8px; border-bottom:1px solid #eee;}
    .hidden{display:none;}
    .muted{color:#777; font-size:13px;}
    .mono{font-family:monospace; background:#eef; padding:2px 6px; border-radius:6px;}
  </style>

</head>
<body>

<h2>Starter Accounting ERP</h2>
<div id="auth-info" class="muted">Not signed in</div>

<div class="grid">

  <!-- LEFT PANEL -->
  <div>

    <!-- AUTH SECTION -->
    <div class="card">
      <h3>Authentication</h3>
      <div id="auth-forms">
        <div class="row">
          <input id="email" placeholder="Email">
          <input id="password" placeholder="Password" type="password">
          <button id="btn-signup">Sign Up</button>
          <button id="btn-signin">Sign In</button>
        </div>
      </div>

      <div id="auth-actions" class="hidden">
        <button id="btn-signout">Sign Out</button>
        <button id="btn-refresh">Refresh Data</button>
      </div>
    </div>

    <!-- CUSTOMERS -->
    <div class="card">
      <h3>Customers</h3>
      <div class="row">
        <input id="cust-id" placeholder="Customer ID">
        <input id="cust-name" placeholder="Customer Name">
        <button id="btn-add-customer">Add</button>
      </div>
      <div id="customers-list"></div>
    </div>

    <!-- INVOICES -->
    <div class="card">
      <h3>Sales Invoices</h3>
      <div class="row">
        <input id="inv-id" placeholder="Invoice ID">
        <input id="inv-date" type="date">
        <select id="inv-customer"><option value="">Choose customer</option></select>
        <input id="inv-amount" type="number" placeholder="Amount">
        <button id="btn-add-invoice">Create</button>
      </div>
      <div id="invoices-list"></div>
    </div>

    <!-- PAYMENTS -->
    <div class="card">
      <h3>Payments</h3>
      <div class="row">
        <input id="pay-id" placeholder="Payment ID">
        <input id="pay-date" type="date">
        <select id="pay-customer"><option value="">Partner</option></select>
        <input id="pay-amount" type="number" placeholder="Amount">
        <select id="pay-type"><option>Customer</option><option>Supplier</option></select>
        <button id="btn-add-payment">Record</button>
      </div>
      <div id="payments-list"></div>
    </div>

    <!-- ALLOCATION -->
    <div class="card">
      <h3>Allocate Payment</h3>
      <div class="row">
        <select id="alloc-payment"><option value="">Select payment</option></select>
        <button id="btn-load-invoices">Load Invoices</button>
      </div>
      <div id="alloc-invoices"></div>
      <button id="btn-apply-allocation">Apply Allocation</button>
    </div>

    <!-- TRIAL BALANCE -->
    <div class="card">
      <h3>Trial Balance</h3>
      <button id="btn-load-trial">Refresh</button>
      <div id="trial-list"></div>
    </div>

  </div>

  <!-- RIGHT PANEL -->
  <div>

    <!-- SUPABASE INIT -->
    <div class="card">
      <h3>Supabase Config</h3>
      <input id="supabase-url" placeholder="SUPABASE_URL" style="width:100%">
      <input id="supabase-key" placeholder="SUPABASE_ANON_KEY" style="width:100%; margin-top:6px;">
      <button id="btn-init" style="margin-top:10px;">Initialize Client</button>
    </div>

    <!-- LOG -->
    <div class="card">
      <h3>Log</h3>
      <pre id="log" style="height:300px; overflow:auto; background:#eef; padding:8px"></pre>
    </div>

  </div>
</div>

<script>

/* LOGGING */
function log(msg){
  document.getElementById("log").textContent += msg + "\n";
}

let client = null;

/*******************************
 * INIT SUPABASE CLIENT
 *******************************/
document.getElementById("btn-init").onclick = async () => {

  const url = document.getElementById("supabase-url").value.trim();
  const key = document.getElementById("supabase-key").value.trim();

  if(!url || !key){
    alert("Enter Supabase URL + Key first");
    return;
  }

  // create client using ESM loader
  client = window.SupabaseCreateClient(url, key);

  log("Supabase client created.");

  const { error } = await client.from("customers").select("*").limit(1);
  if(error){
    log("Connection error: " + error.message);
  } else {
    log("Connected to Supabase successfully.");
  }
};

/*******************************
 * AUTH MODULE (WORKING)
 *******************************/

/* SIGN UP */
document.getElementById("btn-signup").onclick = async () => {
  if(!client){ return alert("Initialize client first."); }

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  if(!email || !password){
    alert("Enter email and password");
    return;
  }

  const { data, error } = await client.auth.signUp({
    email,
    password
  });

  if(error){
    log("Sign-up error: " + error.message);
    alert(error.message);
    return;
  }

  log("Sign-up successful. Check your email.");
  alert("Account created! Verify your email.");
};

/* SIGN IN */
document.getElementById("btn-signin").onclick = async () => {
  if(!client){ return alert("Initialize client first."); }

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  const { data, error } = await client.auth.signInWithPassword({
    email,
    password
  });

  if(error){
    log("Sign-in error: " + error.message);
    alert(error.message);
    return;
  }

  log("Signed in as: " + data.user.email);
  setUserUI(data.user);
};

/* SIGN OUT */
document.getElementById("btn-signout").onclick = async () => {
  await client.auth.signOut();
  log("Signed out.");
  setUserUI(null);
};

/* SESSION RESTORE */
client?.auth?.onAuthStateChange((event, session) => {
  if(session?.user){
    setUserUI(session.user);
  } else {
    setUserUI(null);
  }
});

/* UPDATE UI */
function setUserUI(user){
  const forms = document.getElementById("auth-forms");
  const actions = document.getElementById("auth-actions");
  const info = document.getElementById("auth-info");

  if(user){
    forms.classList.add("hidden");
    actions.classList.remove("hidden");
    info.textContent = "Signed in as " + user.email;
  } else {
    forms.classList.remove("hidden");
    actions.classList.add("hidden");
    info.textContent = "Not signed in";
  }
}

/*******************************
 * REMAINDER OF MODULES
 *******************************/

/* LOAD CUSTOMERS */
async function loadCustomers(){
  if(!client) return;
  const { data, error } = await client.from("customers").select("*");
  document.getElementById("customers-list").textContent =
    JSON.stringify(data || [], null, 2);
}

/* LOAD INVOICES */
async function loadInvoices(){
  if(!client) return;
  const { data, error } = await client.from("sales_invoices").select("*");
  document.getElementById("invoices-list").textContent =
    JSON.stringify(data || [], null, 2);
}

/* LOAD PAYMENTS */
async function loadPayments(){
  if(!client) return;
  const { data } = await client.from("payments").select("*");
  document.getElementById("payments-list").textContent =
    JSON.stringify(data || [], null, 2);
}

/* LOAD TRIAL BALANCE */
document.getElementById("btn-load-trial").onclick = async () => {
  if(!client) return;
  const { data } = await client.from("trial_balance").select("*");
  document.getElementById("trial-list").textContent =
    JSON.stringify(data || [], null, 2);
};

</script>

</body>
</html>
